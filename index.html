<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Editor de Carreteras con Segmentos</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; }
  #sidebar {
    width: 250px;
    background: #f9f9f9;
    border-right: 1px solid #ccc;
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
  }
  #mapContainer {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #ddd;
  }
  svg { border: 1px solid #333; max-width: 95%; max-height: 95%; background: #f2f2f2; }
  .current, .saved, .editable {
    stroke-width: 3;
    fill: none;
    vector-effect: non-scaling-stroke;
  }
  .current { stroke: red; }
  .saved { stroke: blue; }
  .editable { stroke: blue; }
  .point { fill: darkgreen; cursor: pointer; }
  .selectedPoint { fill: yellow; }
  .selectedSegment { stroke: orange; stroke-width: 4; }
  button, select { width: 100%; padding: 6px; margin-bottom: 5px; }
  textarea { width: 100%; height: 120px; resize: none; }
  h2 { font-size: 18px; margin: 0 0 10px 0; }
  p { font-size: 14px; margin: 0 0 10px 0; }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Editor de Carreteras</h2>
  <p>Haz clic en el mapa para a√±adir puntos. Usa la rueda del rat√≥n para hacer zoom.</p>

  <button onclick="newRoad()">‚ûï Nueva carretera</button>
  <button onclick="newSegment()">‚ûï Nuevo segmento</button>
  <button onclick="saveRoad()">üíæ Guardar cambios</button>
  <button onclick="downloadJSON()">üìÅ Guardar archivo</button>
  <button onclick="deleteRoad()">‚ùå Eliminar carretera</button>
  <input type="file" accept=".json" onchange="loadJSON(event)">

  <label for="roadSelect">Modificar carretera:</label>
  <select id="roadSelect">
    <option value="">-- Ninguna --</option>
  </select>

  <textarea id="coords" readonly></textarea>
</div>

<div id="mapContainer">
  <svg id="map" viewBox="0 0 1000 800">
    <g id="mapGroup" transform="translate(0,0) scale(1)">
      <image href="MapaBase.png" x="0" y="0" width="1000" height="800"/>
    </g>
  </svg>
</div>

<script>
let roads = [];
let roadCounter = 1;

const svg = document.getElementById("map");
const mapGroup = document.getElementById("mapGroup");
const output = document.getElementById("coords");
const roadSelect = document.getElementById("roadSelect");

let selectedRoad = null;
let selectedSegment = null;
let selectedPoint = null;
let dragging = false;

// Zoom
let scale = 1;
let translateX = 0;
let translateY = 0;

function getSVGCoords(evt) {
  const pt = svg.createSVGPoint();
  pt.x = evt.clientX;
  pt.y = evt.clientY;
  let svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
  svgP.x = (svgP.x - translateX) / scale;
  svgP.y = (svgP.y - translateY) / scale;
  return svgP;
}

function updateTransform() {
  mapGroup.setAttribute("transform", `translate(${translateX},${translateY}) scale(${scale})`);
  Array.from(mapGroup.querySelectorAll(".point")).forEach(c => c.setAttribute("r", 6/scale));
}

svg.addEventListener("wheel", (e) => {
  e.preventDefault();
  const pt = svg.createSVGPoint();
  pt.x = e.clientX;
  pt.y = e.clientY;
  const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
  const zoomFactor = 1.1;
  const delta = e.deltaY < 0 ? zoomFactor : 1/zoomFactor;
  translateX = svgP.x - (svgP.x - translateX) * delta;
  translateY = svgP.y - (svgP.y - translateY) * delta;
  scale *= delta;
  updateTransform();
});

// --- CREACI√ìN DE CARRETERAS Y SEGMENTOS ---
function newRoad() {
  let roadName = window.prompt("Introduce el nombre de la carretera:", "Carretera " + roadCounter);
  if (!roadName || roadName.trim()==="") roadName = "Carretera " + roadCounter;
  roadCounter++;
  let road = { nombre: roadName, segmentos: [{ puntos: [] }] };
  roads.push(road);

  const option = document.createElement("option");
  option.value = roadName;
  option.textContent = roadName;
  roadSelect.appendChild(option);

  roadSelect.value = roadName;
  selectedRoad = road;
  selectedSegment = road.segmentos[0];
  drawEditableRoad();
}

function newSegment() {
  if (!selectedRoad) { alert("Selecciona una carretera primero"); return; }
  const seg = { puntos: [] };
  selectedRoad.segmentos.push(seg);
  selectedSegment = seg;
  drawEditableRoad();
}

// --- DIBUJO ---
function drawEditableRoad() {
  Array.from(mapGroup.querySelectorAll(".editable,.point")).forEach(el => el.remove());

  // Dibujar todas las carreteras
  roads.forEach(road => {
    road.segmentos.forEach(seg => {
      const poly = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
      poly.setAttribute("points", seg.puntos.map(p=>p.join(",")).join(" "));
      // Si es la carretera seleccionada y el segmento es el seleccionado ‚Üí naranja
      if (road === selectedRoad && seg === selectedSegment) poly.setAttribute("class","editable selectedSegment");
      else poly.setAttribute("class","editable"); // azul
      mapGroup.appendChild(poly);

      // Dibujar puntos solo si es la carretera seleccionada
      if (road === selectedRoad) {
        seg.puntos.forEach(p => {
          const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          c.setAttribute("cx", p[0]);
          c.setAttribute("cy", p[1]);
          c.setAttribute("r", 6/scale);
          c.setAttribute("class","point");
          if (p === selectedPoint) c.classList.add("selectedPoint");
          mapGroup.appendChild(c);
        });
      }
    });
  });

  output.value = JSON.stringify({ carreteras: roads }, null, 2);
  updateTransform();
}

// --- CLIC PARA A√ëADIR PUNTOS O SELECCIONAR ---
svg.addEventListener("click", e => {
  const {x,y} = getSVGCoords(e);
  if (!selectedRoad) return;

  // Click sobre un punto
  let hitPoint = null;
  selectedRoad.segmentos.forEach(seg => {
    seg.puntos.forEach(p => {
      if (Math.hypot(p[0]-x,p[1]-y) < 6/scale) hitPoint = p;
    });
  });
  if (hitPoint) {
    selectedPoint = hitPoint;
    selectedSegment = selectedRoad.segmentos.find(s=>s.puntos.includes(hitPoint));
    drawEditableRoad();
    return;
  }

  // Click sobre un segmento
  let hitSegment = null;
  selectedRoad.segmentos.forEach(seg => {
    for (let i=0;i<seg.puntos.length-1;i++){
      let p1=seg.puntos[i], p2=seg.puntos[i+1];
      let dist = distancePointToSegment([x,y],p1,p2);
      if (dist<5/scale) hitSegment=seg;
    }
  });
  if (hitSegment) {
    selectedSegment = hitSegment;
    selectedPoint = null;
    drawEditableRoad();
    return;
  }

  // A√±adir punto al segmento actual
  if (selectedSegment) {
    selectedSegment.puntos.push([x,y]);
    drawEditableRoad();
  }
});

function distancePointToSegment(p, a, b){
  const [px,py]=p, [ax,ay]=a, [bx,by]=b;
  const dx=bx-ax, dy=by-ay;
  const len2=dx*dx+dy*dy;
  if(len2===0) return Math.hypot(px-ax,py-ay);
  let t=((px-ax)*dx+(py-ay)*dy)/len2;
  t=Math.max(0,Math.min(1,t));
  return Math.hypot(px-(ax+t*dx),py-(ay+t*dy));
}

// --- ARRASTRE DE PUNTOS ---
svg.addEventListener("mousedown", e=>{ if(!selectedPoint) return; dragging=true; });
svg.addEventListener("mousemove", e=>{ 
  if(!dragging || !selectedPoint) return; 
  const {x,y} = getSVGCoords(e);
  selectedPoint[0]=x;
  selectedPoint[1]=y;
  drawEditableRoad();
});
svg.addEventListener("mouseup", ()=> dragging=false);

// --- BORRADO ---
document.addEventListener("keydown", e=>{
  if(e.key==="Delete"){
    if(selectedPoint && selectedSegment){
      selectedSegment.puntos = selectedSegment.puntos.filter(p=>p!==selectedPoint);
      selectedPoint=null;
      drawEditableRoad();
    } else if (selectedSegment && selectedRoad){
      selectedRoad.segmentos = selectedRoad.segmentos.filter(s=>s!==selectedSegment);
      selectedSegment=null;
      drawEditableRoad();
    }
  }
});

// --- ELIMINAR CARRETERA ---
function deleteRoad(){
  if(!selectedRoad) return;
  if(!confirm(`¬øEliminar la carretera "${selectedRoad.nombre}"?`)) return;
  roads = roads.filter(r => r !== selectedRoad);
  roadSelect.value="";
  selectedRoad = selectedSegment = selectedPoint = null;
  drawEditableRoad();
}

// --- GUARDAR Y CARGAR ---
function saveRoad(){
  if(!selectedRoad){ alert("No hay carretera seleccionada"); return; }
  drawEditableRoad();
}

function downloadJSON(){
  if (roads.length===0) return alert("No hay carreteras");
  const blob=new Blob([JSON.stringify({carreteras:roads},null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="carreteras.json";a.click();
  URL.revokeObjectURL(url);
}

function loadJSON(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    const content=JSON.parse(e.target.result);
    roads=content.carreteras||[];
    roadCounter=roads.length+1;
    roadSelect.innerHTML='<option value="">-- Ninguna --</option>';
    roads.forEach(r=>{
      const opt=document.createElement("option");
      opt.value=r.nombre;
      opt.textContent=r.nombre;
      roadSelect.appendChild(opt);
    });
    selectedRoad=null;
    selectedSegment=null;
    selectedPoint=null;
    drawEditableRoad();
  };
  reader.readAsText(file);
}

roadSelect.addEventListener("change", ()=>{
  selectedRoad=roads.find(r=>r.nombre===roadSelect.value)||null;
  selectedSegment=selectedRoad?selectedRoad.segmentos[0]:null;
  selectedPoint=null;
  drawEditableRoad();
});
</script>
</body>
</html>

